<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Alerts Dashboard</title>
  <link rel="stylesheet" href="/static/alerts.css" />
</head>
<body>
  <header>
    <h1>Alerts Dashboard</h1>
    <div class="filters">
      <input id="sensorId" placeholder="sensor_id (vd: sensor-1)">
      <input id="q" placeholder="search msg/rule_id">
      <select id="priority">
        <option value="">priority (all)</option>
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      </select>
      <select id="since">
        <option value="15">15m</option>
        <option value="60" selected>60m</option>
        <option value="1440">24h</option>
        <option value="10080">7d</option>
      </select>
      <select id="limit">
        <option>25</option><option selected>50</option><option>100</option><option>200</option>
      </select>
      <button id="apply">Apply</button>
      <span id="meta"></span>
    </div>
  </header>

  <section id="stats"></section>

  <section>
    <table id="tbl">
      <thead>
        <tr>
          <th>ts</th><th>sensor</th><th>priority</th><th>rule_id</th>
          <th>msg</th><th>src</th><th>dst</th><th>proto</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="pager">
      <button id="prev">Prev</button>
      <span id="pageinfo"></span>
      <button id="next">Next</button>
      <label><input type="checkbox" id="autorefresh" checked> auto refresh</label>
    </div>
  </section>

  <script>
    let page = 1, timer=null;

    function qs(id){ return document.getElementById(id); }

    async function fetchJSON(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(await r.text());
      return await r.json();
    }

    function buildQuery() {
      const p = new URLSearchParams();
      if(qs("sensorId").value) p.set("sensor_id", qs("sensorId").value.trim());
      if(qs("q").value)        p.set("q", qs("q").value.trim());
      if(qs("priority").value) p.set("priority", qs("priority").value);
      p.set("since_minutes", qs("since").value);
      p.set("page", page);
      p.set("limit", qs("limit").value);
      return p.toString();
    }

    function renderRows(items){
      const tb = qs("tbl").querySelector("tbody");
      tb.innerHTML = "";
      for(const x of items){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${x.ts ?? ""}</td>
          <td>${x.sensor_id ?? ""}</td>
          <td class="pri p${x.priority||""}">${x.priority ?? ""}</td>
          <td>${x.rule_id ?? ""}</td>
          <td class="msg" title="${x.msg ?? ""}">${(x.msg||"").slice(0,80)}</td>
          <td>${x.src?.ip||""}:${x.src?.port||""}</td>
          <td>${x.dst?.ip||""}:${x.dst?.port||""}</td>
          <td>${x.proto ?? ""}</td>`;
        tb.appendChild(tr);
      }
    }

    function renderPageMeta(total, limit){
      const maxPage = Math.max(1, Math.ceil(total/limit));
      qs("pageinfo").textContent = `Page ${page} / ${maxPage} — ${total} alerts`;
      qs("prev").disabled = page<=1;
      qs("next").disabled = page>=maxPage;
      qs("meta").textContent = new Date().toLocaleTimeString();
    }

    async function loadAlerts(){
      const q = buildQuery();
      const data = await fetchJSON(`/api/v1/alerts?${q}`);
      renderRows(data.items);
      renderPageMeta(data.total, data.limit);
      loadStats(); // cập nhật stats kèm
    }

    async function loadStats(){
      const m = qs("since").value;
      const s = await fetchJSON(`/api/v1/alerts/stats?since_minutes=${m}`);
      // gọn gàng thành bảng
      const el = qs("stats");
      el.innerHTML = "<h3>Stats (alerts by sensor & priority)</h3>";
      const tbl = document.createElement("table");
      const head = `<tr><th>sensor</th><th>p1</th><th>p2</th><th>p3</th><th>p4</th><th>p5</th></tr>`;
      tbl.innerHTML = head;
      for(const [sid, obj] of Object.entries(s.by_sensor_priority)){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${sid}</td>` + [1,2,3,4,5].map(p=>`<td>${obj[p]?.toString()||obj[p.toString()]||0}</td>`).join("");
        tbl.appendChild(tr);
      }
      el.appendChild(tbl);
    }

    function scheduleAutoRefresh(){
      if(timer) clearInterval(timer);
      if(qs("autorefresh").checked){
        timer = setInterval(()=>{ loadAlerts().catch(console.error); }, 5000);
      }
    }

    // events
    qs("apply").onclick = ()=>{ page = 1; loadAlerts().catch(alert); };
    qs("prev").onclick  = ()=>{ page = Math.max(1, page-1); loadAlerts().catch(alert); };
    qs("next").onclick  = ()=>{ page = page+1; loadAlerts().catch(alert); };
    qs("autorefresh").onchange = scheduleAutoRefresh;

    // init
    loadAlerts().catch(console.error);
    scheduleAutoRefresh();
  </script>
</body>
</html>
